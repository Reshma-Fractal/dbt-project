
resources:
# The repo with our Dockerfile
 - name: gke-app
   type: git
   icon: github
   source:
     uri: ((git_url))
     branch: ((git_branch))

jobs:
  - name: set-self
    plan:
      - get: gke-app
        trigger: true

      - task: tag-the-image
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: concourse/git-resource
          inputs:
          - name: gke-app
          outputs:
          - name: commit-id
          run:
            path: sh
            args:
            - -cx
            - |
                echo $(git rev-parse HEAD) > commit-id.txt
            dir: gke-app
      - set_pipeline: self
        file: gke-app/concourse/test/set_pipeline.yml
        vars:
          git_url: ((git_url))
          git_branch : ((git_branch))
          image_tag:   ((.cat commit-id/commit-id.txt))
          artifact_repo : ((artifact_repo))
          service_account : ((service_account))

  
  - name: "set-protected-build-pipelines"
    plan:
      - get: gke-app
        trigger: true
        passed: [set-self]
      
      - set_pipeline: bq-deploy-test
        file: gke-app/concourse/test/test.yml
        vars:
          image_tag: ((image_tag))
          git_url: ((git_url))
          git_branch : ((git_branch))
          artifact_repo : ((artifact_repo))
          service_account : ((service_account))
      